# Check for changesets on non-main branches
current_branch="$(git branch --show-current 2>/dev/null)"

if [ "$current_branch" != "main" ] && [ -n "$current_branch" ]; then
  changeset_files="$(git diff origin/main --diff-filter=A --name-only -- .changeset/ 2>/dev/null | grep '\.md$' | grep -v 'README\.md' | grep -v 'simulatedRelease' || true)"

  if [ -z "$changeset_files" ]; then
    echo ""
    echo "No changeset detected on branch '$current_branch'"
    echo "Run 'pnpm changeset' to create one."
    echo ""
    printf "Push anyway? [y/N] "
    read -r answer < /dev/tty
    case "$answer" in
      [yY]|[yY][eE][sS]) ;;
      *)
        echo "Push aborted."
        exit 1
        ;;
    esac
  fi
fi

# Run full cspell check before pushing to catch violations that would fail CI
echo "Running cspell check..."
pnpm cspell:all
if [ $? -ne 0 ]; then
  echo ""
  echo "cspell found spelling errors. Either:"
  echo "  1. Fix the typo"
  echo "  2. Add the word to a dictionary file in packages/monorepo.cspell/"
  echo "  3. Add a cspell:ignore comment above the line"
  exit 1
fi
